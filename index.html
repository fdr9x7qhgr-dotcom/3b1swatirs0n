<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğğ ğ‚ğ€ğ‘ğ“ğğ…ğ„ğ‹ ğ…ğ‘ğˆğ“ğ„</title>
<style>
body { font-family: Arial; direction: rtl; text-align: center; padding: 10px; }
input, select, button { width: 100%; padding: 8px; margin: 4px 0; }
table { width:100%; border-collapse: collapse; margin-top:10px; font-size:14px; }
th, td { border:1px solid #333; padding:5px; text-align:center; }
.paid { background:#c8f7c5; }
.unpaid { background:#f7c5c5; }
.action-btn { padding:4px 8px; margin:2px; cursor:pointer; font-size:12px; }
#menuDropdown button { width: 100%; margin:3px 0; }
</style>
</head>
<body>

<h3>ğğ ğ‚ğ€ğ‘ğ“ğğ…ğ„ğ‹ ğ…ğ‘ğˆğ“ğ„</h3>

<!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø· -->
<div style="position: fixed; top: 10px; right: 10px; z-index: 1000;">
  <button id="menuBtn" style="font-size: 20px; padding: 5px 10px; cursor: pointer;">â‹®</button>
  <div id="menuDropdown" style="display: none; position: absolute; right: 0; background: #fff; border: 1px solid #333; padding: 5px; text-align: right;">
    <button id="backupBtn" class="action-btn">Backup</button><br>
    <button id="restoreBtn" class="action-btn">Restore</button>
  </div>
</div>

<label>Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…:</label>
<input type="date" id="datePicker">

<h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª</h4>
<input id="newShopName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
<input id="newShopDebt" placeholder="Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£ÙˆÙ„ÙŠ">
<button onclick="addShop()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„</button>
<button onclick="deleteShop()">âŒ Ù…Ø³Ø­ Ù…Ø­Ù„</button>

<hr>

<select id="shopSelect" onchange="loadOldDebt()">
<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ù„</option>
</select>

<input id="oldDebt" placeholder="Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ…" readonly>
<input id="qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
<input id="price" placeholder="Ø«Ù…Ù†/ÙƒÙŠÙ„Ùˆ">
<input id="total" placeholder="Ø§Ù„Ø«Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ø¨" readonly>
<input id="paid" placeholder="Ø§Ù„Ù…Ø¯ÙÙˆØ¹">
<input id="newDebt" placeholder="Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯" readonly>
<input id="sumDebt" placeholder="Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¨Ø§Ù‚ÙŠ" readonly>

<button onclick="addRecord()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¬Ø¯ÙˆÙ„</button>
<button onclick="clearDay()">Ù…Ø³Ø­ Ø§Ù„ÙŠÙˆÙ…</button>

<table>
<thead>
<tr>
<th>Ø§Ù„Ù…Ø­Ù„</th>
<th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
<th>Ø«Ù…Ù†/ÙƒÙŠÙ„Ùˆ</th>
<th>Ø§Ù„Ø«Ù…Ù†</th>
<th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
<th>Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯</th>
<th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¨Ø§Ù‚ÙŠ</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
<th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody id="table"></tbody>
</table>

<script>
let editIndex = null;
let currentDate = getToday();
document.getElementById("datePicker").value = currentDate;

// Ø§Ù„Ù…Ø­Ù„Ø§Øª
let shops = JSON.parse(localStorage.getItem("shops")||"{}");
// Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ… Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
let records = JSON.parse(localStorage.getItem("records_"+currentDate)||"[]");

function getToday(){
    const d=new Date();
    return d.toISOString().split('T')[0];
}

// Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function save(){
    localStorage.setItem("shops", JSON.stringify(shops));
    localStorage.setItem("records_"+currentDate, JSON.stringify(records));
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª
function loadShops(){
    let s=document.getElementById("shopSelect");
    s.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ù„</option>';
    for(let k in shops){
        let o=document.createElement("option");
        o.value=k;
        o.textContent=k;
        s.appendChild(o);
    }
}
loadShops();

// Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„
function addShop(){
    let name=document.getElementById("newShopName").value.trim();
    let debt=parseFloat(document.getElementById("newShopDebt").value)||0;
    if(!name){alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„");return;}
    shops[name]=debt;
    save();
    loadShops();
    document.getElementById("newShopName").value="";
    document.getElementById("newShopDebt").value="";
}

// Ù…Ø³Ø­ Ù…Ø­Ù„
function deleteShop(){
    let s=document.getElementById("shopSelect").value;
    if(!s){alert("Ø§Ø®ØªØ± Ù…Ø­Ù„");return;}
    if(confirm("Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ù„ØŸ")){
        delete shops[s];
        save();
        loadShops();
        render();
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ù„
function loadOldDebt(){
    let s=document.getElementById("shopSelect").value;
    document.getElementById("oldDebt").value=shops[s]||0;
    calc();
}

// Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
let qty=document.getElementById("qty");
let price=document.getElementById("price");
let paid=document.getElementById("paid");
let oldDebt=document.getElementById("oldDebt");
let totalInput=document.getElementById("total");
let newDebt=document.getElementById("newDebt");
let sumDebt=document.getElementById("sumDebt");

qty.oninput=price.oninput=paid.oninput=calc;

function calc(){
    let q=parseFloat(qty.value)||0;
    let p=parseFloat(price.value)||0;
    let pay=parseFloat(paid.value)||0;
    let old=parseFloat(oldDebt.value)||0;

    let total=q*p;
    let newD=Math.max(0,total-pay);
    let extraPay=Math.max(0,pay-total);
    let remainingOld=Math.max(0,old-extraPay);
    let sum=remainingOld + newD;

    totalInput.value=total.toFixed(2);
    newDebt.value=newD.toFixed(2);
    sumDebt.value=sum.toFixed(2);

    // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if(newD === 0 && sum > 0){
        sumDebt.style.background="#f7c5c5"; // Ø£Ø­Ù…Ø±
    } else if(sum <= 0){
        sumDebt.style.background="#c8f7c5"; // Ø£Ø®Ø¶Ø±
    } else {
        sumDebt.style.background="";
    }
}

// Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø¬Ù„
function addRecord(){
    let shop=shopSelect.value;
    if(!shop){alert("Ø§Ø®ØªØ± Ù…Ø­Ù„");return;}

    let total=+totalInput.value;
    let pay=+paid.value;
    let newD=+newDebt.value;
    let sum=+sumDebt.value;

    // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ©
    let status = "";
    if(newD === 0 && sum > 0){
        status = "Ù…Ø®Ù„ØµØ´ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ…";
    } else if(sum <=0){
        status = "Ø®Ø§Ù„Øµ";
    } else {
        status = "Ù…Ø®Ù„ØµØ´";
    }

    records.push({
        shop,
        qty:+qty.value,
        price:+price.value,
        total,
        pay,
        newD,
        sum,
        status
    });

    // ØªØ­Ø¯ÙŠØ« Ø¯ÙŠÙ† Ø§Ù„Ù…Ø­Ù„
    shops[shop]=sum;

    save();
    render();
    loadOldDebt();

    qty.value=price.value=paid.value="";
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
function render(){
    let t=document.getElementById("table");
    t.innerHTML="";
    records.forEach((r,index)=>{
        let tr=document.createElement("tr");
        // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        if(r.newD === 0 && r.sum > 0){
            tr.className="unpaid";
            r.status = "Ù…Ø®Ù„ØµØ´ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ…";
        } else if(r.sum <=0){
            tr.className="paid";
            r.status = "Ø®Ø§Ù„Øµ";
        } else {
            tr.className="unpaid";
            r.status = "Ù…Ø®Ù„ØµØ´";
        }
        tr.innerHTML=`
            <td>${r.shop}</td>
            <td>${r.qty}</td>
            <td>${r.price}</td>
            <td>${r.total}</td>
            <td>${r.pay}</td>
            <td>${r.newD}</td>
            <td>${r.sum}</td>
            <td>${r.status}</td>
            <td>
                <button class="action-btn" onclick="editRow(${index})">ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="action-btn" onclick="deleteRow(${index})">Ø­Ø°Ù</button>
            </td>
        `;
        t.appendChild(tr);
    });
}
render();

// ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ
function editRow(index){
    let r=records[index];
    document.getElementById("shopSelect").value=r.shop;
    loadOldDebt();
    qty.value=r.qty;
    price.value=r.price;
    totalInput.value=r.total;
    paid.value=r.pay;
    newDebt.value=r.newD;
    sumDebt.value=r.sum;
    editIndex=index;
}

// Ø­Ø°Ù ØµÙ
function deleteRow(index){
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙØŸ")){
        records.splice(index,1);
        save();
        render();
    }
}

// Ù…Ø³Ø­ Ø§Ù„ÙŠÙˆÙ…
function clearDay(){
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ø¯ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…ØŸ")){
        records=[];
        save();
        render();
    }
}

// Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
document.getElementById("datePicker").addEventListener("change", () => {
    currentDate = document.getElementById("datePicker").value;
    records = JSON.parse(localStorage.getItem("records_"+currentDate) || "[]");
    editIndex = null;
    render();
    loadOldDebt();
});

// Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø·
document.getElementById("menuBtn").addEventListener("click",()=>{
    const menu=document.getElementById("menuDropdown");
    menu.style.display=menu.style.display==="none"?"block":"none";
});

// Backup
document.getElementById("backupBtn").addEventListener("click",()=>{
    const data=records;
    const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download=`backup_${currentDate}.json`;
    a.click();
    URL.revokeObjectURL(url);
    alert("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
});

// Restore
document.getElementById("restoreBtn").addEventListener("click",()=>{
    const input=document.createElement("input");
    input.type="file";
    input.accept=".json";
    input.onchange=e=>{
        const file=e.target.files[0];
        const reader=new FileReader();
        reader.onload=event=>{
            try{
                const restoredData=JSON.parse(event.target.result);
                records=restoredData;
                save();
                render();
                alert("ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
            }catch{
                alert("Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
            }
        };
        reader.readAsText(file);
    };
    input.click();
});
</script>

</body>
</html>
